WITH allocated AS (

	SELECT

		al.DOCUMENT_NO ALLOCATION_DOCUMENT_NO,
		SUM(al.PAY_AMOUNT) ALLOCATION_PAY_AMOUNT_SUM

	FROM ACC_IMPL.BANK_STATEMENT_ITEM bsi
	LEFT JOIN ACC_IMPL.ALLOCATION al ON al.BANK_STATEMENT_ITEM_ID = bsi.BANK_STATEMENT_ITEM_ID
	LEFT JOIN acc.PAYMENT_ORDER payOrder on payOrder.PAYMENT_ORDER_NUMBER = al.DOCUMENT_NO
	LEFT JOIN acc_impl.PAYMENT_ORDER_HUB payOrderHub on payOrderHub.PAYMENT_ORDER_NUMBER = payOrder.PAYMENT_ORDER_NUMBER
	LEFT JOIN acc_impl.PAYMENT_ORDER_SAT_LATEST payOrderSat on payOrderSat.PAYMENT_ORDER_HKEY = payOrderHub.PAYMENT_ORDER_HKEY

	WHERE 1=1

		AND bsi.STATUS_ID IN (1, 2)
		AND bsi.TRANSACTION_DATE >= @transactionDateFrom
		AND al.CANCELLED_ALLOCATION_ID is null
		AND al.CANCELLED = 0
		AND (al.DOCUMENT_TYPE_ID not in (2,3) or (al.DOCUMENT_TYPE_ID in (2,3) and payOrderSat.PAYMENT_ORDER_TYPE = 'Claim'))

    GROUP BY al.DOCUMENT_NO

	HAVING SUM(al.PAY_AMOUNT) >= @amountFrom
)

SELECT DISTINCT

	bsi.BANK_STATEMENT_ITEM_ID,
	bsi.AMOUNT BANK_STATEMENT_ITEM_AMOUNT,
	bsi.DIRECTION,
    al.DOCUMENT_NO ALLOCATION_DOCUMENT_NO,
	allocated.ALLOCATION_PAY_AMOUNT_SUM ALLOCATION_PAY_AMOUNT_SUM

FROM ACC_IMPL.BANK_STATEMENT_ITEM bsi
LEFT JOIN ACC_IMPL.ALLOCATION al ON al.BANK_STATEMENT_ITEM_ID = bsi.BANK_STATEMENT_ITEM_ID
LEFT JOIN allocated ON allocated.ALLOCATION_DOCUMENT_NO = al.DOCUMENT_NO

WHERE 1=1

    AND bsi.STATUS_ID IN (@paymentStatusIds)
    AND bsi.TRANSACTION_DATE >= @transactionDateFrom

	{{#if parameters.isNotAllocated}}
        AND bsi.AMOUNT >= @amountFrom
        AND bsi.DIRECTION = @direction
    {{/if}}

    {{#if parameters.isAllocated}}
	    AND allocated.ALLOCATION_PAY_AMOUNT_SUM >= @amountFrom
    {{/if}}
