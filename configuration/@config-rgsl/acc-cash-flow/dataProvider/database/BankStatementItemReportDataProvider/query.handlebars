select
    bsi.BANK_STATEMENT_ITEM_ID,
	bsi.BANK_STATEMENT_ITEM_NO,
	bsi.INCOME_SOURCE_ID,
	bsi.PAYMENT_DESCRIPTION,
    bsi.ORIGINAL_PAYMENT_DESCRIPTION,
	bsi.TRANSACTION_DATE,
	bsi.CREATE_DATE,
    bsi.PAYMENT_DATE,
	bsi.AMOUNT,
	bsi.DIRECTION,
	bsi.CURRENCY_CODE,
	bsi.STATUS_ID,
	bsi.OPEN_AMOUNT,
	null as DOCUMENT_NO,
	null as DUE_DATE,
	null as ALLOCATED_AMOUNT,
	bsi.IS_REGISTRY,
	bsi.IS_ACQUIRING,
	bsi.NON_ACCEPTANCE,
	bsi.SEGMENT,
	bsi.REGISTRY_REFERENCE_NO,
	bsi.DEBTOR_NAME,
	bsi.DEBTOR_TYPE,
	bsi.DEBTOR_BANK_ACCOUNT_NO,
	bsi.CREDITOR_NAME,
	bsi.CREDITOR_TYPE,
	bsi.CREDITOR_BANK_ACCOUNT_NO,
	bsi.RGSL_GUID,
	(select top 1 SOURCE_FILE_FORMAT from acc_impl.AGGREGATED_PAYMENT_REGISTER where AGGREGATED_PAYMENT_NUMBER = bsi.REGISTRY_REFERENCE_NO) as REGISTRY_FILE_FORMAT
from
	acc_impl.BANK_STATEMENT_ITEM bsi
	inner join acc_impl.EXPORT_REPORT_LOG log on bsi.BANK_STATEMENT_ITEM_ID = log.BANK_STATEMENT_ITEM_ID
where 1=1
	and bsi.STATUS_ID != 2
	and log.EXPORT_REPORT_GUID = @exportReportGuid
union all
select
    bsi.BANK_STATEMENT_ITEM_ID,
	bsi.BANK_STATEMENT_ITEM_NO,
	bsi.INCOME_SOURCE_ID,
	bsi.PAYMENT_DESCRIPTION,
    bsi.ORIGINAL_PAYMENT_DESCRIPTION,
	bsi.TRANSACTION_DATE,
	bsi.CREATE_DATE,
    bsi.PAYMENT_DATE,
	bsi.AMOUNT,
	bsi.DIRECTION,
	bsi.CURRENCY_CODE,
	bsi.STATUS_ID,
	0 as OPEN_AMOUNT,
	alc.DOCUMENT_NO,
	alcp.DUE_DATE,
	alc.PAY_AMOUNT as ALLOCATED_AMOUNT,
	bsi.IS_REGISTRY,
	bsi.IS_ACQUIRING,
	bsi.NON_ACCEPTANCE,
	bsi.SEGMENT,
	bsi.REGISTRY_REFERENCE_NO,
	bsi.DEBTOR_NAME,
	bsi.DEBTOR_TYPE,
	bsi.DEBTOR_BANK_ACCOUNT_NO,
	bsi.CREDITOR_NAME,
	bsi.CREDITOR_TYPE,
	bsi.CREDITOR_BANK_ACCOUNT_NO,
	bsi.RGSL_GUID,
	(select top 1 SOURCE_FILE_FORMAT from acc_impl.AGGREGATED_PAYMENT_REGISTER where AGGREGATED_PAYMENT_NUMBER = bsi.REGISTRY_REFERENCE_NO) as REGISTRY_FILE_FORMAT
from
	acc_impl.BANK_STATEMENT_ITEM bsi
	inner join acc_impl.EXPORT_REPORT_LOG log on bsi.BANK_STATEMENT_ITEM_ID = log.BANK_STATEMENT_ITEM_ID
	inner join acc_impl.ALLOCATION alc on alc.BANK_STATEMENT_ITEM_ID = bsi.BANK_STATEMENT_ITEM_ID
	inner join acc_impl.ALLOCATION_POLICY alcp on alcp.allocation_id = alc.allocation_id
where 1=1
	and alc.CANCELLED = 0
	and alc.CANCELLED_ALLOCATION_ID is null
	and log.EXPORT_REPORT_GUID = @exportReportGuid
