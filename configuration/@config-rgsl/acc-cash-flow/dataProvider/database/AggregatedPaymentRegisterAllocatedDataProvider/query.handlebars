SELECT
	bsi.BANK_STATEMENT_ITEM_ID,
	bsi.IMPORT_DOCUMENT_ID,
	bsi.BANK_STATEMENT_ITEM_NO,
	bsi.INCOME_SOURCE_ID,
	bsi.PAYMENT_DESCRIPTION,
	bsi.ORIGINAL_PAYMENT_DESCRIPTION,
	bsi.TRANSACTION_DATE,
	bsi.CREATE_DATE,
	bsi.PAYMENT_DATE,
	bsi.AMOUNT,
	bsi.DIRECTION,
	bsi.CURRENCY_CODE,
	bsi.STATUS_ID,
	bsi.OPEN_AMOUNT,
	bsi.IS_REGISTRY,
	bsi.IS_ACQUIRING,
	bsi.NON_ACCEPTANCE,
	bsi.TOLERANCE_TYPE,
	bsi.SEGMENT,
	bsi.REGISTRY_REFERENCE_NO,
	(
		select STRING_AGG(pr.REFERENCE_NO, ', ') WITHIN GROUP (ORDER BY pr.ORDER_NO)
		from ACC_IMPL.PAYMENT_REFERENCE pr
		where pr.BANK_STATEMENT_ITEM_ID = bsi.BANK_STATEMENT_ITEM_ID
	) as REFERENCE_NUMBERS,
	bsi.PAYMENT_SOURCE_ID,
	-- debtor
	bsi.DEBTOR_NAME,
	bsi.DEBTOR_TYPE,
	bsi.DEBTOR_BANK_ACCOUNT_NO,
	-- creditor
	bsi.CREDITOR_NAME,
	bsi.CREDITOR_TYPE,
	bsi.CREDITOR_BANK_ACCOUNT_NO
FROM
	ACC_IMPL.BANK_STATEMENT_ITEM bsi
	inner join ACC_IMPL.ALLOCATION alc on alc.BANK_STATEMENT_ITEM_ID = bsi.BANK_STATEMENT_ITEM_ID
WHERE 1=1
{{#if parameters.aggregatedPaymentNumber}}
	and alc.DOCUMENT_NO = @aggregatedPaymentNumber
{{/if}}