select
    ref.BANK_STATEMENT_ITEM_ID,
    ref.REFERENCE_NO,
    ref.ORDER_NO,
    coalesce(ref.ERROR_MESSAGE, 'Ok') as AUTO_ALLOCATION_MESSAGE,
    ref.IS_ERROR
from
    ACC_IMPL.BANK_STATEMENT_ITEM bsi
    left join ACC_IMPL.ALLOCATION alc on alc.BANK_STATEMENT_ITEM_ID = bsi.BANK_STATEMENT_ITEM_ID
    left join ACC_IMPL.BANK_STATEMENT_ITEM smallPay on smallPay.REGISTRY_REFERENCE_NO = alc.DOCUMENT_NO
    inner join ACC_IMPL.PAYMENT_REFERENCE ref on ref.BANK_STATEMENT_ITEM_ID = coalesce(smallPay.BANK_STATEMENT_ITEM_ID, bsi.BANK_STATEMENT_ITEM_ID)
where bsi.BANK_STATEMENT_ITEM_ID = @bankStatementItemId
