SELECT DISTINCT
	aa.AGENT_AGREEMENT_ID,
	aa.AGENT_AGREEMENT_NUMBER,
	aasl.MANUAL_NUMBER,
	aasl.EXTERNAL_NUMBER,
	spisl.PARTNER_CODE,
	spisl.PARTY_CODE
FROM ORG_IMPL.SERVICE_PROVIDER_INFO_SAT_LATEST spisl
JOIN ORG_IMPL.SERVICE_PROVIDER_HUB sph ON sph.SERVICE_PROVIDER_HKEY = spisl.SERVICE_PROVIDER_INFO_HKEY
JOIN ORG.SERVICE_PROVIDER sp ON sp.SERVICE_PROVIDER_CODE = sph.SERVICE_PROVIDER_CODE
JOIN PAS_IMPL.AA_PARTICIPANT_LINK aapl ON aapl.SERVICE_PROVIDER_HKEY = sph.SERVICE_PROVIDER_HKEY
JOIN PAS_IMPL.AA_SAT_LATEST aasl ON aasl.AA_HKEY = aapl.AA_HKEY
JOIN PAS_IMPL.AA_HUB aah ON aah.AA_HKEY = aasl.AA_HKEY
JOIN PAS.AGENT_AGREEMENT aa ON aa.AGENT_AGREEMENT_NUMBER = aah.AA_NUMBER
JOIN PAS.AGENT_AGREEMENT aa1 ON aa.AGENT_AGREEMENT_ID = aa1.ORIGINAL_DOCUMENT_ID
WHERE spisl.PARTNER_TYPE = 'agent' AND spisl.PARTNER_CODE IN (@partnerCodes)
AND (aa1.SEQ_NUMBER = 0 OR aa1.VERSION_STATE = 'Applied')