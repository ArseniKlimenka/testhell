SELECT
	hist.NEW_STATE,
	hist.TRANSITION,
	hist.CHANGED_ON,
	hist.HISTORY_VERSION,
	users.USERNAME as CHANGED_BY_USER,
	pa.CODE_NAME as DOCUMENT_TYPE,
	hist.BUSINESS_ID as DOCUMENT_NUMBER
FROM
	BFX.ENTITY_HISTORY hist
LEFT JOIN ORG.APPLICATION_USER users
	ON users.APPLICATION_USER_ID = hist.CHANGE_CAUSED_BY
LEFT JOIN bfx.ENTITY_REF e on hist.ENTITY_ID = e.ENTITY_ID
LEFT JOIN CFX.PUBLISHED_ARTIFACT pa ON pa.PUBLISHED_ARTIFACT_ID = e.PUBLISHED_ARTIFACT_ID
WHERE
{{#if parameters.documentNumber}}
	hist.BUSINESS_ID = @documentNumber
	AND hist.STATE_CHANGED = 1
	AND pa.CODE_NAME in ('AgentAgreement', 'AAChangeAmendment', 'AACancellationAmendment')
{{else}}
1=2
{{/if}}
ORDER BY CHANGED_ON ASC