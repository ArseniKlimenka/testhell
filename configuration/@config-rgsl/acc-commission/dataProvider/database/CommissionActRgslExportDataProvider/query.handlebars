SELECT
	ai.ACT_ID,
	ai.ACT_NO,
	ai.ISSUE_DATE,
	ai.AGENT_PARTY_NAME,
	ai.AGENT_AGREEMENT_NUMBER,
	ai.CONCLUSION_DATE,
	ai.REPORTING_PERIOD_FROM,
	ai.REPORTING_PERIOD_TO,
	ai.COMM_AMOUNT_LC,
	ai.VAT_AMOUNT_LC,
	ai.INNKIO,
	ai.BANK_ACCOUNT,
	ai.CORRESPONDENT_ACCOUNT,
	ai.BIC,
{{#if parameters.groupByContract}}
	NULL ACT_ITEM_ID,
{{else}}
	ai.ACT_ITEM_ID,
{{/if}}
	ai.REFERENCE_NO,
	ai.HOLDER_NAME,
	ai.POL_START_DATE,
	ai.DOC_CURRENCY_CODE,
	ai.PRODUCT_DESC,
	ai.INSURED_YEARS_COUNT,
	ai.PAYMENT_TRANSACTION_DATE,
	SUM(ai.PAYMENT_DOC_AMOUNT) PAYMENT_DOC_AMOUNT,
	ai.COMM_RATE_FINAL,
	SUM(ai.LC_COMM_AMOUNT_FINAL) LC_COMM_AMOUNT_FINAL,
	ai.DUE_DATE
FROM (
SELECT
	act.ACT_ID,
	act.ACT_NO,
	act.ISSUE_DATE,
	pis.FULL_NAME as AGENT_PARTY_NAME,
	act.AGENT_AGREEMENT_NUMBER,
	aas.CONCLUSION_DATE,
	act.REPORTING_PERIOD_FROM,
	act.REPORTING_PERIOD_TO,
	act.COMM_AMOUNT_LC,
	act.VAT_AMOUNT_LC,
	pis.INNKIO,
	bank.BANK_ACCOUNT,
	bank.CORRESPONDENT_ACCOUNT,
	bank.BIC,
	ai.ACT_ITEM_ID,
	ai.REFERENCE_NO,
	polsl.HOLDER_NAME,
	polsl.START_DATE as POL_START_DATE,
	ai.DOC_CURRENCY_CODE,
	prod.DESCRIPTION as PRODUCT_DESC,
	CAST(ROUND(DATEDIFF(day, polsl.START_DATE, polsl.END_DATE) / 365.25, 0, 1) as INT) + 1 as INSURED_YEARS_COUNT,
	ai.PAYMENT_TRANSACTION_DATE,
	ai.PAYMENT_DOC_AMOUNT,
	ai.COMM_RATE_FINAL,
	ai.LC_COMM_AMOUNT_FINAL,
	ai.DUE_DATE
from acc_impl.CA_ACT act
	join ORG_IMPL.SERVICE_PROVIDER_HUB sph on sph.SERVICE_PROVIDER_CODE = act.AGENT_SERVICE_PROVIDER_CODE
	join ORG_IMPL.SERVICE_PROVIDER_INFO_SAT_LATEST spis on spis.SERVICE_PROVIDER_INFO_HKEY = sph.SERVICE_PROVIDER_HKEY
	join PTY_IMPL.PARTY_HUB ph on ph.PARTY_CODE = spis.PARTY_CODE
	join PTY_IMPL.PARTY_INFO_SAT_LATEST pis on pis.PARTY_INFO_HKEY = ph.PARTY_HKEY
	join pas_impl.AA_HUB aah on aah.AA_NUMBER = act.AGENT_AGREEMENT_NUMBER
	join pas_impl.AA_SAT_LATEST aas on aas.AA_HKEY = aah.AA_HKEY
	left join (SELECT TOP 1 * FROM pty_impl.PARTY_BANK_ACCOUNTS_SAT_LATEST) bank on bank.PARTY_BANK_ACCOUNTS_HKEY = ph.PARTY_HKEY
	left join acc_impl.CA_ACT_ITEM ai on ai.ACT_ID = act.ACT_ID
	left join pas_impl.POLICY_HUB polh on polh.CONTRACT_NUMBER = ai.REFERENCE_NO
	left join pas_impl.POLICY_SAT_LATEST polsl on polsl.POLICY_HKEY = polh.POLICY_HKEY
	left join bfx_impl.PRODUCTS prod on prod.code = polsl.PRODUCT_CODE
where 1=1
	and (ai.LC_COMM_AMOUNT_CALC != 0 or ai.LC_COMM_AMOUNT_EXTRA != 0 or ai.IS_TECHNICAL = 1)
	and ai.STATUS_ID != 2
{{#if parameters.actId}}
	and act.ACT_ID = @actId
{{/if}}
{{#if parameters.actNo}}
	and act.ACT_NO = @actNo
{{/if}}
	and (bank.OPENING_DATE IS NULL or act.ISSUE_DATE >= bank.OPENING_DATE)
	and (bank.CLOSING_DATE IS NULL or act.ISSUE_DATE <= bank.CLOSING_DATE)
) ai
GROUP BY
	ai.ACT_ID,
	ai.ACT_NO,
	ai.ISSUE_DATE,
	ai.AGENT_PARTY_NAME,
	ai.AGENT_AGREEMENT_NUMBER,
	ai.CONCLUSION_DATE,
	ai.REPORTING_PERIOD_FROM,
	ai.REPORTING_PERIOD_TO,
	ai.COMM_AMOUNT_LC,
	ai.VAT_AMOUNT_LC,
	ai.INNKIO,
	ai.BANK_ACCOUNT,
	ai.CORRESPONDENT_ACCOUNT,
	ai.BIC,
{{#unless parameters.groupByContract}}
	ai.ACT_ITEM_ID,
{{/unless}}
	ai.REFERENCE_NO,
	ai.HOLDER_NAME,
	ai.POL_START_DATE,
	ai.DOC_CURRENCY_CODE,
	ai.PRODUCT_DESC,
	ai.INSURED_YEARS_COUNT,
	ai.PAYMENT_TRANSACTION_DATE,
	ai.COMM_RATE_FINAL,
	ai.DUE_DATE