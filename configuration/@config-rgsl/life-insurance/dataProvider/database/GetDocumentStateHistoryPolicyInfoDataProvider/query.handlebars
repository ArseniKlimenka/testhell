SELECT 
	c.CONTRACT_NUMBER,
	pub.CODE_NAME CONTRACT_CODE_NAME,
	psl.HOLDER_NAME,
	hist.NEW_STATE,
	hist.TRANSITION,
	hist.CHANGED_ON
FROM
	BFX.ENTITY_HISTORY hist
INNER JOIN BFX.ENTITY_REF ent ON ent.ENTITY_ID = hist.ENTITY_ID
INNER JOIN CFX.PUBLISHED_ARTIFACT pub ON pub.PUBLISHED_ARTIFACT_ID = ent.PUBLISHED_ARTIFACT_ID
LEFT JOIN PAS.CONTRACT canc ON canc.CONTRACT_ID = hist.ENTITY_ID
LEFT JOIN PAS.CONTRACT c ON c.CONTRACT_ID = canc.ORIGINAL_DOCUMENT_ID
LEFT JOIN PAS_IMPL.POLICY_HUB ph ON ph.CONTRACT_NUMBER = c.CONTRACT_NUMBER
LEFT JOIN PAS_IMPL.POLICY_SAT_LATEST psl ON psl.POLICY_HKEY = ph.POLICY_HKEY
WHERE
	1 = 1
	{{#if parameters.newState}}
    AND NEW_STATE = @newState
    {{/if}}
	{{#if parameters.transition}}
    AND TRANSITION = @transition
    {{/if}}
