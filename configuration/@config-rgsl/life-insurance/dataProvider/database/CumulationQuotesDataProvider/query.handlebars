SELECT
	c.CONTRACT_NUMBER,
	pa.CODE_NAME CONTRACT_CONF_CODE_NAME,
	contractSat.PRODUCT_CODE,
	contractSat.CURRENCY_CODE,
	contractSat.END_DATE AS CONTRACT_END_DATE,
	crgR.GROUP_CODE RISK_GROUP_CODE,
	risks.RISK_CODE,
	risks.RISK_START_DATE,
	risks.RISK_END_DATE,
	CONVERT(DECIMAL(15, 2), risks.RISK_PREMIUM) RISK_PREMIUM,
	CONVERT(DECIMAL(15, 2), risks.RISK_INSURED_SUM) RISK_INSURED_SUM,
	CONVERT(DECIMAL(15, 2), risks.RISK_INSURED_SUM_WITHOUT_CASHBACK) RISK_INSURED_SUM_WITHOUT_CASHBACK,
	risks.RISK_PERSON,
	CONVERT(DECIMAL(15, 2), riskInsuredSumByPeriod.RISK_PERIOD_INSURED_SUM) RISK_PERIOD_INSURED_SUM,
	riskInsuredSumByPeriod.RISK_PERIOD_START_DATE,
	riskInsuredSumByPeriod.RISK_PERIOD_END_DATE,
	CASE
		WHEN RISK_PERSON = 'insuredPerson' then contractSat.INSURED_CODE
		ELSE contractSat.HOLDER_CODE
	END AS PARTY_CODE
FROM
	pas.CONTRACT c
	LEFT JOIN CFX.PUBLISHED_ARTIFACT pa ON pa.PUBLISHED_ARTIFACT_ID = c.PUBLISHED_ARTIFACT_ID
	LEFT JOIN PAS_IMPL.QUOTE_HUB contractHub ON contractHub.CONTRACT_NUMBER = c.CONTRACT_NUMBER
	LEFT JOIN PAS_IMPL.QUOTE_SAT_LATEST contractSat ON contractSat.QUOTE_HKEY = contractHub.QUOTE_HKEY
	LEFT JOIN CFG.PROCESS_STATE procState ON procState.PROCESS_STATE_ID = c.STATE_ID
	CROSS APPLY OPENJSON(JSON_QUERY(c.body, '$.risks')) WITH (
		RISK_CODE NVARCHAR(64) '$.risk.riskCode',
		RISK_START_DATE NVARCHAR(64) '$.startDate',
		RISK_END_DATE NVARCHAR(64) '$.endDate',
		RISK_PREMIUM NVARCHAR(64) '$.riskPremium',
		RISK_INSURED_SUM NVARCHAR(64) '$.riskInsuredSum',
		RISK_INSURED_SUM_WITHOUT_CASHBACK NVARCHAR(64) '$.riskInsuredSumWithoutCashBack',
		RISK_PERSON NVARCHAR(64) '$.risk.riskPerson',
		riskInsuredSumByPeriod NVARCHAR(MAX) '$.riskInsuredSumByPeriod' AS JSON
	) risks
	OUTER APPLY OPENJSON(risks.riskInsuredSumByPeriod) WITH (
		RISK_PERIOD_INSURED_SUM NVARCHAR(64) '$.insuredSum',
		RISK_PERIOD_START_DATE NVARCHAR(64) '$.periodStartDate',
		RISK_PERIOD_END_DATE NVARCHAR(64) '$.periodEndDate'
	) riskInsuredSumByPeriod
	LEFT JOIN PAS_IMPL.CUMULATION_RISK_GROUP_RELATION crgR ON crgR.RISK_CODE = risks.RISK_CODE
	LEFT JOIN BFX_IMPL.RISKS r ON r.CODE = risks.RISK_CODE
WHERE
	1 = 1
	AND c.CONTRACT_NUMBER IN (@contractNumbers)
	AND (
		(
			contractSat.INSURED_CODE = @insuredPersonCode
			AND RISK_PERSON = 'insuredPerson'
		)
		OR (
			contractSat.HOLDER_CODE = @policyHolderCode
			AND RISK_PERSON = 'policyHolder'
		)
	)
	AND (@currentDate >= RISK_START_DATE AND @currentDate <= RISK_END_DATE OR r.PAYMENT_FORM = 'SurrenderValues')