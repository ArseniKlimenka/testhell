SELECT
	v.STATE,
	SUBSTRING((
		SELECT ',' + ve.ERROR_DESCRIPTION_FULL  AS [text()]
		FROM PAS_IMPL.VERIFICATION_ERROR_SAT ve
		WHERE ve.VERIFICATION_ERROR_HKEY = v.VERIFICATION_HKEY
		AND ve.LOAD_DATE = (SELECT TOP 1
							MIN(ve.LOAD_DATE)
							FROM PAS_IMPL.VERIFICATION_ERROR_SAT ve
							WHERE ve.LOAD_DATE <= v.LOAD_DATE
							GROUP BY ve.LOAD_DATE
							ORDER BY ve.LOAD_DATE DESC)
		AND ve.IS_DELETED = 0
		ORDER BY ve.ERROR_CODE
		FOR XML PATH (''), TYPE
	).value('text()[1]','nvarchar(max)'),2,1000) VERIFICATION_ERRORS,
	STUFF(CONCAT(','+v.OPERATIONS_COMMENT, ','+v.SELLER_COMMENT), 1, 1, '') COMMENTS,
	v.LOAD_DATE,
	v.OPERATIONS_USERNAME
FROM PAS_IMPL.VERIFICATION_SAT v
JOIN PAS_IMPL.VERIFICATION_HUB vh ON vh.VERIFICATION_HKEY = v.VERIFICATION_HKEY 
WHERE 1 = 1
{{#if parameters.verificationNumber}}
AND vh.VERIFICATION_NUMBER = @verificationNumber
{{/if}}