SELECT DISTINCT
		pch.PRODUCT_CONF_NUMBER,
        ume.UNIVERSAL_MASTER_ENTITY_CODE,
        c.CONTRACT_NUMBER,
        pa.CODE_NAME CONTRACT_CODE_NAME,
        aaSatL.EXTERNAL_NUMBER,
        aaSatL.MANUAL_NUMBER,
        ps.RATE_OF_RETURN,
        pcsl.MANUAL_RATE,
        pcsl.CALCULATED_RATE,
        eps.PRODUCT_CODE,
        eps.RULE_NUM,
        eps.ISSUE_DATE_START,
        eps.ISSUE_DATE_END,
        eps.INSURANCE_TERM_FROM,
        eps.INSURANCE_TERM_TO,
        eps.PARTNER_CODE,
        eps.PARTNER_BUSINESS_CODE,
        eps.AGENT_AGREEMENT_ID,
        eps.AGENT_AGREEMENT_NUMBER,
        eps.AGENT_AGREEMENT_MANUAL_NUMBER,
        eps.AGENT_AGREEMENT_EXT_NUMBER,
        eps.AGENT_AGREEMENT_COMM_RATE,
        eps.CURRENCY_CODE,
        eps.PAYMENT_FREQUENCY_CODE,
        eps.GUARANTEE_INCOME_CODE,
        eps.BIP_STRATEGY_CODE,
        eps.BIP_STRATEGY_DESCRIPTION,
        eps.ROR_ISSUE_DATE_FROM,
        eps.ROR_ISSUE_DATE_TO,
        eps.ROR_STRATEGY_CODE,
        eps.ROR_INSURANCE_TERMS,
        eps.ROR_CURRENCY_CODE,
        eps.ROR_GUARANTEE_INCOME_CODE,
        eps.ROR_RATE_OF_RETURN,
        eps.ROR_MANUAL_RATE,
        eps.SC_ISSUE_DATE_FROM,
        eps.SC_ISSUE_DATE_TO,
        eps.SC_OPTION_PRICE,
        eps.SC_FIX_RATE,
        eps.SC_PARTICIPATION_COEFF,
        eps.SC_CURRENCY_CODE,
        eps.SEGMENT,
        eps.ISIN,
        eps.RKO,
        eps.MOTIVATION_FROM_MARGIN,
        eps.MOTIVATION_FROM_PRODUCT_ECONOMIC,
        eps.SK_MARGIN,
        eps.FUNDING_RATE_SWAPS,
        eps.LAPS,
        eps.HEDGE,
        eps.CLIENT_ID,
        eps.SHARE_RF,
        eps.SHARE_GF,
        eps.RVD,
        eps.FUNDING_VER_SUB_FUND_ID,
        eps.MEMORANDUM_PK_DATE,
        eps.PK_NUMBER,
        eps.ANALYTICAL_ADJUSTMENT,
        eps.EXPECTED_RETURN_PERCENT_AK,
        eps.INSURANCE,
        eps.RISK_TRANSFER_PRODUCT,
        eps.COMMENTS,
        apsl.IS_MANUAL_CORRECTION
FROM UNIV_IMPL.ECONOMIC_PARAMETER_SAT_LATEST eps
JOIN UNIV_IMPL.ECONOMIC_PARAMETER_HUB eph ON eph.ECONOMIC_PARAMETER_HKEY = eps.ECONOMIC_PARAMETER_HKEY
JOIN PAS_IMPL.POLICY_SAT_LATEST ps ON ps.PRODUCT_CODE = eps.PRODUCT_CODE
JOIN PAS_IMPL.POLICY_HUB ph ON ph.POLICY_HKEY = ps.POLICY_HKEY
JOIN BFX_IMPL.PRODUCTS pr ON pr.CODE = ps.PRODUCT_CODE
JOIN PAS.CONTRACT c ON c.CONTRACT_NUMBER = ph.CONTRACT_NUMBER
JOIN CFX.PUBLISHED_ARTIFACT pa ON pa.PUBLISHED_ARTIFACT_ID = c.PUBLISHED_ARTIFACT_ID
JOIN ORG.SERVICE_PROVIDER sp ON sp.SERVICE_PROVIDER_CODE = ps.PARTNER_CODE
JOIN ORG_IMPL.SERVICE_PROVIDER_HUB sph ON sph.SERVICE_PROVIDER_CODE = sp.SERVICE_PROVIDER_CODE
JOIN ORG_IMPL.SERVICE_PROVIDER_INFO_SAT_LATEST spisl ON spisl.SERVICE_PROVIDER_INFO_HKEY = sph.SERVICE_PROVIDER_HKEY
LEFT JOIN PAS_IMPL.POLICY_INVESTMENT_SAT_LATEST pInvSL ON pInvSL.POLICY_INVESTMENT_HKEY = ph.POLICY_HKEY
LEFT JOIN BFX_IMPL.ADDITIONAL_PARAMETERS_POLICY_LINK appl ON appl.POLICY_HKEY = ph.POLICY_HKEY
LEFT JOIN BFX_IMPL.ADDITIONAL_PARAMETERS_HUB aph ON aph.ADDITIONAL_PARAMETERS_HKEY = appl.ADDITIONAL_PARAMETERS_HKEY
LEFT JOIN BFX_IMPL.ADDITIONAL_PARAMETERS_SAT_LATEST apsl ON apsl.ADDITIONAL_PARAMETERS_HKEY = aph.ADDITIONAL_PARAMETERS_HKEY
LEFT JOIN BFX.UNIVERSAL_MASTER_ENTITY ume ON ume.UNIVERSAL_MASTER_ENTITY_CODE = aph.DOCUMENT_NUMBER
LEFT JOIN UNIV_IMPL.PRODUCT_CONF_SAT_LATEST pConfSL ON pConfSL.PRODUCT_CODE = ps.PRODUCT_CODE
LEFT JOIN UNIV_IMPL.PRODUCT_CONF_HUB pch ON pch.PRODUCT_CONF_HKEY = pConfSL.PRODUCT_CONF_HKEY
JOIN BFX.UNIVERSAL_VERSIONED_DOCUMENT uvd ON uvd.UNIVERSAL_VERSIONED_DOCUMENT_NUMBER = pch.PRODUCT_CONF_NUMBER
JOIN PAS_IMPL.POLICY_COMMISSION_LINK pcl ON pcl.POLICY_HKEY = ph.POLICY_HKEY
JOIN PAS_IMPL.POLICY_COMMISSION_SAT_LATEST pcsl ON pcsl.POLICY_COMMISSION_HKEY = pcl.POLICY_COMMISSION_HKEY AND pcsl.PERIOD_NUMBER = 1 AND pcsl.ITEM_CODE = (
	SELECT TOP 1
		pcsl.ITEM_CODE
	FROM PAS_IMPL.POLICY_HUB phInner
	JOIN PAS_IMPL.POLICY_COMMISSION_LINK pcl ON pcl.POLICY_HKEY = ph.POLICY_HKEY
	JOIN PAS_IMPL.POLICY_COMMISSION_SAT_LATEST pcsl ON pcsl.POLICY_COMMISSION_HKEY = pcl.POLICY_COMMISSION_HKEY
	WHERE phInner.CONTRACT_NUMBER = ph.CONTRACT_NUMBER AND pcsl.PERIOD_NUMBER = 1
)
JOIN PAS_IMPL.AA_HUB aaHub ON aaHub.AA_HKEY = pcl.AA_HKEY
JOIN PAS_IMPL.AA_SAT_LATEST aaSatL ON aaSatL.AA_HKEY = aaHub.AA_HKEY
WHERE 1 = 1

{{#if parameters.productCode}}
    AND eps.PRODUCT_CODE = @productCode
{{/if}}

{{#if parameters.selectedRules}}
    AND eps.RULE_NUM IN (@selectedRules)
{{/if}}

{{#if parameters.contractNumbers}}
    AND ph.CONTRACT_NUMBER IN (@contractNumbers)
{{/if}}

{{#if parameters.productGroups}}
    AND pr.PRODUCT_GROUP IN (@productGroups)
{{/if}}

AND (ps.IS_MIGRATED = 0 OR ps.IS_MIGRATED IS NULL)

AND uvd.SEQ_NUMBER = (
	SELECT MAX(SEQ_NUMBER) FROM BFX.UNIVERSAL_VERSIONED_DOCUMENT uvdIn
	WHERE uvdIn.ORIGINAL_DOCUMENT_ID = uvd.ORIGINAL_DOCUMENT_ID AND eph.PRODUCT_CONF_NUMBER = uvd.UNIVERSAL_VERSIONED_DOCUMENT_NUMBER AND uvdIn.VERSION_STATE = 'Applied'
)

AND spisl.PARTNER_CODE = eps.PARTNER_BUSINESS_CODE
AND ps.PRODUCT_CODE = eps.PRODUCT_CODE
AND aaSatL.EXTERNAL_NUMBER = eps.AGENT_AGREEMENT_EXT_NUMBER
AND (eps.ISSUE_DATE_START <= ps.ISSUE_DATE AND ps.ISSUE_DATE <= eps.ISSUE_DATE_END)
AND (eps.INSURANCE_TERM_FROM <= ps.INSURANCE_TERMS AND ps.INSURANCE_TERMS <= eps.INSURANCE_TERM_TO)
AND ps.CURRENCY_CODE = eps.CURRENCY_CODE
AND (ps.PAYMENT_FREQUENCY_CODE = eps.PAYMENT_FREQUENCY_CODE OR (ps.PAYMENT_FREQUENCY_CODE IS NULL AND eps.PAYMENT_FREQUENCY_CODE IS NULL))
AND ((pcsl.MANUAL_RATE IS NOT NULL AND pcsl.MANUAL_RATE = eps.AGENT_AGREEMENT_COMM_RATE) OR (pcsl.MANUAL_RATE IS NULL AND pcsl.CALCULATED_RATE = eps.AGENT_AGREEMENT_COMM_RATE))

AND (pInvSL.STRATEGY_CODE = eps.BIP_STRATEGY_CODE OR (pInvSL.STRATEGY_CODE IS NULL) AND eps.BIP_STRATEGY_CODE IS NULL)
AND (ps.GUARANTEE_INCOME_CODE = eps.GUARANTEE_INCOME_CODE OR (ps.GUARANTEE_INCOME_CODE IS NULL) AND eps.GUARANTEE_INCOME_CODE IS NULL)
AND ((eps.ROR_RATE_OF_RETURN IS NOT NULL AND ps.RATE_OF_RETURN = eps.ROR_RATE_OF_RETURN)
OR (eps.ROR_RATE_OF_RETURN IS NULL AND (
(pInvSL.OPTION_PRICE = eps.SC_OPTION_PRICE OR (pInvSL.OPTION_PRICE IS NULL) AND eps.SC_OPTION_PRICE IS NULL)
AND (pInvSL.FIX_RATE = eps.SC_FIX_RATE OR (pInvSL.FIX_RATE IS NULL) AND eps.SC_FIX_RATE IS NULL)
AND (pInvSL.PARTICIPATION_COEFF = eps.SC_PARTICIPATION_COEFF OR (pInvSL.PARTICIPATION_COEFF IS NULL) AND eps.SC_PARTICIPATION_COEFF IS NULL)
)))
