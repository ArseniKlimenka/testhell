SELECT 

	ud.UNIVERSAL_DOCUMENT_NUMBER REQUEST_NUMBER,
	ud.BODY REQUEST_BODY,
	psUd.CODE_NAME,
	CONVERT(DATE, ud.SYS_CREATED_ON) REQUEST_CREATED_ON,
	inqS.INCLUDED_IN_RP_REGISTER INCLUDED_IN_RUSSIAN_POST_REGISTER,
	paUd.CODE_NAME INQUIRY_TYPE,
	amS.VALID_FROM RECEIVED_DATE,
	ps.PRODUCT_CODE POLICY_PRODUCT_CODE,
	ps.ISSUE_DATE POLICY_ISSUE_DATE

FROM BFX.UNIVERSAL_DOCUMENT ud
LEFT JOIN CFX.PUBLISHED_ARTIFACT paUd ON paUd.PUBLISHED_ARTIFACT_ID = ud.PUBLISHED_ARTIFACT_ID
LEFT JOIN CFG.PROCESS_STATE psUd ON psUd.PROCESS_STATE_ID = ud.STATE_ID
LEFT JOIN PAS_IMPL.INQUIRY_HUB inqH ON inqH.INQUIRY_NUMBER = ud.UNIVERSAL_DOCUMENT_NUMBER
LEFT JOIN PAS_IMPL.INQUIRY_SAT_LATEST inqS ON inqS.INQUIRY_HKEY = inqH.INQUIRY_HKEY
LEFT JOIN PAS_IMPL.CNL_INQUIRY_LINK inqL ON inqL.INQUIRY_HKEY = inqH.INQUIRY_HKEY
LEFT JOIN PAS_IMPL.AMENDMENT_HUB amH ON amH.AMENDMENT_HKEY = inqL.AMENDMENT_HKEY
LEFT JOIN PAS.CONTRACT am ON am.CONTRACT_NUMBER = amH.AMENDMENT_NUMBER
LEFT JOIN PAS.CONTRACT p ON p.CONTRACT_ID = am.ORIGINAL_DOCUMENT_ID
LEFT JOIN PAS_IMPL.POLICY_HUB ph ON ph.CONTRACT_NUMBER = p.CONTRACT_NUMBER
LEFT JOIN PAS_IMPL.POLICY_SAT_LATEST ps ON ps.POLICY_HKEY = ph.POLICY_HKEY
LEFT JOIN CFG.PROCESS_STATE psAm ON psAm.PROCESS_STATE_ID = am.STATE_ID
LEFT JOIN PAS_IMPL.AMENDMENT_SAT_LATEST amS ON amS.AMENDMENT_HKEY = amH.AMENDMENT_HKEY

WHERE amS.AMENDMENT_TYPE = 'Cancellation'
AND psUd.CODE_NAME = 'Draft'
AND psAm.CODE_NAME NOT IN ('Cancelled', 'Rejected', 'Active', 'Paid')
AND paUd.CODE_NAME = 'CancellationInquiry'
AND (inqS.DEPARTMENT_CODE = 'agentSalesSupport' OR inqS.DEPARTMENT_CODE = 'partnerSalesSupport' OR inqS.DEPARTMENT_CODE = 'callCenter')
AND (inqS.INCLUDED_IN_RP_REGISTER IS NULL OR inqS.INCLUDED_IN_RP_REGISTER = 'False')
