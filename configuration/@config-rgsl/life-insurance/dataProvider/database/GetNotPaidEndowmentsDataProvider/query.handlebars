SELECT doc.UNIVERSAL_DOCUMENT_NUMBER AS ENDOWMENT_NUMBER 
FROM BFX.UNIVERSAL_DOCUMENT doc
JOIN CFX.PUBLISHED_ARTIFACT art ON art.PUBLISHED_ARTIFACT_ID = doc.PUBLISHED_ARTIFACT_ID AND art.CODE_NAME = 'Endowment'
JOIN.CFG.PROCESS_STATE st ON st.PROCESS_STATE_ID = doc.STATE_ID
JOIN EWT_IMPL.EWT_HUB hub ON hub.ENDOWMENT_NUMBER = doc.UNIVERSAL_DOCUMENT_NUMBER
JOIN EWT_IMPL.EWT_SAT_LATEST eSat ON eSat.EWT_HKEY = hub.EWT_HKEY
JOIN EWT_IMPL.EWT_CONTRACT_LINK link ON link.EWT_HKEY = hub.EWT_HKEY
JOIN EWT_IMPL.EWT_CONTRACT_SAT_LATEST cSat ON cSat.EWT_CONTRACT_HKEY = link.EWT_CONTRACT_HKEY AND IS_DELETED = 0
JOIN PAS_IMPL.POLICY_HUB polHub ON polHub.POLICY_HKEY = link.POLICY_HKEY
WHERE 
eSat.EVENT_TYPE_CODE = '300'
AND st.CODE_NAME NOT IN ('SentToPayment', 'PartiallyPaid', 'Paid', 'Cancelled', 'Rejected')
AND polHub.CONTRACT_NUMBER = @contractNumber
