SELECT
	hist.NEW_STATE,
	hist.TRANSITION,
	hist.CHANGED_ON,
	hist.HISTORY_VERSION,
	users.USERNAME as CHANGED_BY_USER,
	uclaim.VALUE as CHANGED_BY_PARTY,
	upclaim.VALUE as CHANGED_BY_PARTY_CODE,
	pa.CODE_NAME as DOCUMENT_TYPE,
	hist.BUSINESS_ID as DOCUMENT_NUMBER
FROM
	BFX.ENTITY_HISTORY hist
LEFT JOIN ORG.APPLICATION_USER users ON users.APPLICATION_USER_ID = hist.CHANGE_CAUSED_BY
LEFT JOIN ORG.APPLICATION_USER_CLAIM uclaim ON uclaim.APPLICATION_USER_ID = hist.CHANGE_CAUSED_BY AND uclaim.CLAIM_TYPE = 'DisplayName'
LEFT JOIN ORG.APPLICATION_USER_CLAIM upclaim ON upclaim.APPLICATION_USER_ID = hist.CHANGE_CAUSED_BY AND upclaim.CLAIM_TYPE = 'PartyCode'
LEFT JOIN bfx.ENTITY_REF e on hist.ENTITY_ID = e.ENTITY_ID
LEFT JOIN CFX.PUBLISHED_ARTIFACT pa ON pa.PUBLISHED_ARTIFACT_ID = e.PUBLISHED_ARTIFACT_ID
WHERE
{{#if parameters.documentNumber}}
	hist.BUSINESS_ID = @documentNumber
	AND hist.STATE_CHANGED = 1
	AND pa.CODE_NAME in 
		(SELECT 
			CODE_NAME 
		FROM 
			[CFX].PUBLISHED_ARTIFACT 
		WHERE 
			CODE_NAME != 'AACancellationAmendment' AND CODE_NAME != 'CancellationInquiry') 
{{else}}
1=2
{{/if}}
ORDER BY CHANGED_ON ASC