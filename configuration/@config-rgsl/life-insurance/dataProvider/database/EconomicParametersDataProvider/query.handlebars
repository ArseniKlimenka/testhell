SELECT
	   ud_orig.UNIVERSAL_VERSIONED_DOCUMENT_NUMBER
	  ,epsl.PRODUCT_CODE
      ,p.DESCRIPTION
      ,epsl.RULE_NUM
      ,epsl.ISSUE_DATE_START
      ,epsl.ISSUE_DATE_END
      ,epsl.INSURANCE_TERM_FROM
      ,epsl.INSURANCE_TERM_TO
      ,epsl.PARTNER_CODE
      ,epsl.PARTNER_BUSINESS_CODE
      ,pisl.FULL_NAME
      ,epsl.AGENT_AGREEMENT_ID
      ,epsl.AGENT_AGREEMENT_NUMBER
      ,epsl.AGENT_AGREEMENT_EXT_NUMBER
      ,epsl.AGENT_AGREEMENT_MANUAL_NUMBER
      ,epsl.AGENT_AGREEMENT_COMM_RATE
      ,epsl.CURRENCY_CODE
      ,epsl.PAYMENT_FREQUENCY_CODE
      ,epsl.GUARANTEE_INCOME_CODE
      ,epsl.BIP_STRATEGY_CODE
      ,epsl.BIP_STRATEGY_DESCRIPTION
      ,epsl.ROR_ISSUE_DATE_FROM
      ,epsl.ROR_ISSUE_DATE_TO
      ,epsl.ROR_STRATEGY_CODE
      ,epsl.ROR_INSURANCE_TERMS
      ,epsl.ROR_CURRENCY_CODE
      ,epsl.ROR_GUARANTEE_INCOME_CODE
      ,epsl.ROR_RATE_OF_RETURN
      ,epsl.SC_ISSUE_DATE_FROM
      ,epsl.SC_ISSUE_DATE_TO
      ,epsl.SC_OPTION_PRICE
      ,epsl.SC_FIX_RATE
      ,epsl.SC_PARTICIPATION_COEFF
      ,epsl.SC_CURRENCY_CODE
      ,cr.DESCRIPTION as CURRENCY_DESCRIPTION
      ,epsl.SEGMENT
      ,epsl.ISIN
      ,epsl.RKO
      ,epsl.MOTIVATION_FROM_MARGIN
      ,epsl.MOTIVATION_FROM_PRODUCT_ECONOMIC
      ,epsl.SK_MARGIN
      ,epsl.FUNDING_RATE_SWAPS
      ,epsl.LAPS
      ,epsl.HEDGE
      ,epsl.CLIENT_ID
      ,epsl.SHARE_RF
      ,epsl.SHARE_GF
      ,epsl.RVD
      ,epsl.FUNDING_VER_SUB_FUND_ID
      ,epsl.MEMORANDUM_PK_DATE
      ,epsl.PK_NUMBER
      ,epsl.ANALYTICAL_ADJUSTMENT
      ,epsl.EXPECTED_RETURN_PERCENT_AK
      ,epsl.INSURANCE
      ,epsl.RISK_TRANSFER_PRODUCT
      ,epsl.COMMENTS
      ,epsl.LOAD_DATE
      ,pf.DESCRIPTION as PAYMENT_FREQUENCY_DESCRIPTION
FROM BFX.UNIVERSAL_VERSIONED_DOCUMENT uvd
JOIN UNIV_IMPL.ECONOMIC_PARAMETER_HUB eph ON eph.PRODUCT_CONF_NUMBER = uvd.UNIVERSAL_VERSIONED_DOCUMENT_NUMBER
JOIN BFX.UNIVERSAL_VERSIONED_DOCUMENT ud_orig ON ud_orig.UNIVERSAL_VERSIONED_DOCUMENT_ID = uvd.ORIGINAL_DOCUMENT_ID
LEFT JOIN UNIV_IMPL.ECONOMIC_PARAMETER_SAT_LATEST epsl ON epsl.ECONOMIC_PARAMETER_HKEY = eph.ECONOMIC_PARAMETER_HKEY
LEFT JOIN ORG_IMPL.SERVICE_PROVIDER_INFO_SAT_LATEST spisl ON spisl.PARTNER_CODE = epsl.PARTNER_BUSINESS_CODE
LEFT JOIN PTY_IMPL.PARTY_HUB ph on ph.PARTY_CODE = spisl.PARTY_CODE
LEFT JOIN PTY_IMPL.PARTY_INFO_SAT_LATEST pisl on pisl.PARTY_INFO_HKEY = ph.PARTY_HKEY
LEFT JOIN BFX_IMPL.PRODUCTS p on p.CODE = epsl.PRODUCT_CODE
LEFT JOIN BFX.CURRENCY_REF cr on cr.CURRENCY_CODE = epsl.CURRENCY_CODE
LEFT JOIN BFX_IMPL.PAYMENT_FREQUENCY pf on pf.CODE = epsl.PAYMENT_FREQUENCY_CODE
WHERE 1 = 1
{{#if parameters.isLatest}}
    AND uvd.SEQ_NUMBER = (
        SELECT MAX(uvdIn.SEQ_NUMBER)
        FROM BFX.UNIVERSAL_VERSIONED_DOCUMENT uvdIn
        WHERE uvdIn.ORIGINAL_DOCUMENT_ID = uvd.ORIGINAL_DOCUMENT_ID
    )
{{/if}}
{{#if parameters.documentNumber}}
    AND uvd.UNIVERSAL_VERSIONED_DOCUMENT_NUMBER = @documentNumber
{{/if}}
{{#if parameters.insuranceProducts}}
    AND epsl.PRODUCT_CODE IN (@insuranceProducts)
{{/if}}
{{#if parameters.issueDateFrom}}
       AND epsl.ISSUE_DATE_START >= @issueDateFrom
{{/if}}
{{#if parameters.issueDateTo}}
       AND epsl.ISSUE_DATE_START <= @issueDateTo
{{/if}}