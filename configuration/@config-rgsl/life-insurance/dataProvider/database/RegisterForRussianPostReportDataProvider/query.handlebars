SELECT 

	CONVERT(DATE, ud.SYS_CREATED_ON) REQUEST_CREATED_ON, -- Дата создания Запроса
	ud.UNIVERSAL_DOCUMENT_NUMBER REQUEST_NUMBER, -- Заявка
	ptyInfoS.FULL_NAME, -- Заявитель
	ptyInfoS.LAST_NAME, -- Заявитель Фамилия
	ptyInfoS.FIRST_NAME, -- Заявитель Имя
	ptyInfoS.MIDDLE_NAME, ---- Заявитель Отчество
	ptyAddrS.FULL_ADDRESS, -- Куда                  
	p.CONTRACT_NUMBER, -- Номер договора
	ps.ISSUE_DATE, --Дата договора
	cnlAppS.RECEIVE_DATE, -- Дата поступления в СК
	(SELECT 
		CAST(
			CASE
				WHEN CHARINDEX(N'Иное', DESCRIPTION, 0) > 0
					THEN (SELECT REPLACE(DESCRIPTION, N'Иное', '') + inqS.TEXT_OF_INQUIRY + '; ') 
				ELSE DESCRIPTION + '; '
			END AS xml)
	FROM BFX_IMPL.INQUIRY_REASON ir
	LEFT JOIN PAS_IMPL.INQUIRY_REASON_SAT cnlInqRS ON cnlInqRS.INQUIRY_REASON_HKEY = inqH.INQUIRY_HKEY
	WHERE cnlInqRS.INQUIRY_REASON_HKEY = inqH.INQUIRY_HKEY AND ir.CODE = cnlInqRS.REASON_CODE
	FOR XML PATH('')
	) INQUIRY_ERRORS -- Ошибки запроса

FROM BFX.UNIVERSAL_DOCUMENT ud
LEFT JOIN CFX.PUBLISHED_ARTIFACT paUd ON paUd.PUBLISHED_ARTIFACT_ID = ud.PUBLISHED_ARTIFACT_ID
LEFT JOIN CFG.PROCESS_STATE psUd ON psUd.PROCESS_STATE_ID = ud.STATE_ID
LEFT JOIN PAS_IMPL.INQUIRY_HUB inqH ON inqH.INQUIRY_NUMBER = ud.UNIVERSAL_DOCUMENT_NUMBER
LEFT JOIN PAS_IMPL.INQUIRY_SAT_LATEST inqS ON inqS.INQUIRY_HKEY = inqH.INQUIRY_HKEY
LEFT JOIN PAS_IMPL.CNL_INQUIRY_LINK inqL ON inqL.INQUIRY_HKEY = inqH.INQUIRY_HKEY
LEFT JOIN PAS_IMPL.AMENDMENT_HUB amH ON amH.AMENDMENT_HKEY = inqL.AMENDMENT_HKEY
LEFT JOIN PAS_IMPL.CNL_APPLICANT_LINK cnlAppL ON cnlAppL.AMENDMENT_HKEY = amh.AMENDMENT_HKEY
LEFT JOIN PAS_IMPL.CNL_APPLICANT_SAT_LATEST cnlAppS ON cnlAppS.CNL_APPLICANT_HKEY = cnlAppL.CNL_APPLICANT_HKEY
LEFT JOIN PAS.CONTRACT am ON am.CONTRACT_NUMBER = amH.AMENDMENT_NUMBER
LEFT JOIN PAS.CONTRACT p ON p.CONTRACT_ID = am.ORIGINAL_DOCUMENT_ID
LEFT JOIN PAS_IMPL.POLICY_HUB ph ON ph.CONTRACT_NUMBER = p.CONTRACT_NUMBER
LEFT JOIN PAS_IMPL.POLICY_SAT_LATEST ps ON ps.POLICY_HKEY = ph.POLICY_HKEY
LEFT JOIN CFG.PROCESS_STATE psAm ON psAm.PROCESS_STATE_ID = am.STATE_ID
LEFT JOIN PAS_IMPL.AMENDMENT_SAT_LATEST amS ON amS.AMENDMENT_HKEY = amH.AMENDMENT_HKEY
LEFT JOIN PAS_IMPL.CNL_APPLICANT_LINK amAppL ON amAppL.AMENDMENT_HKEY = amH.AMENDMENT_HKEY
LEFT JOIN PTY_IMPL.PARTY_HUB ptyH ON ptyH.PARTY_HKEY = amAppL.PARTY_HKEY
LEFT JOIN PTY_IMPL.PARTY_INFO_SAT_LATEST ptyInfoS ON ptyInfoS.PARTY_INFO_HKEY = ptyH.PARTY_HKEY
LEFT JOIN PTY_IMPL.PARTY_ADDRESSES_SAT_LATEST ptyAddrS ON ptyAddrS.PARTY_ADDRESSES_HKEY = ptyH.PARTY_HKEY

WHERE amS.AMENDMENT_TYPE = 'Cancellation'
AND psUd.CODE_NAME = 'Draft'
AND psAm.CODE_NAME NOT IN ('Cancelled', 'Rejected', 'Active', 'Paid')
AND paUd.CODE_NAME = 'CancellationInquiry'
AND (inqS.DEPARTMENT_CODE = 'agentSalesSupport' OR inqS.DEPARTMENT_CODE = 'partnerSalesSupport' OR inqS.DEPARTMENT_CODE = 'callCenter')
AND inqS.INCLUDED_IN_RP_REGISTER = 'True'
AND ptyAddrS.ADDRESS_TYPE_CODE = 'R'
{{#if parameters.russianPostRegisterInclusionDateFrom}}
    AND CONVERT(date, inqS.INCLUSION_DATE_RP_REGISTER) >= @russianPostRegisterInclusionDateFrom
{{/if}}
{{#if parameters.russianPostRegisterInclusionDateTo}}
    AND CONVERT(date, inqS.INCLUSION_DATE_RP_REGISTER) <= @russianPostRegisterInclusionDateTo
{{/if}}

UNION ALL

SELECT 

	CONVERT(DATE, ud.SYS_CREATED_ON) REQUEST_CREATED_ON, -- Дата создания Запроса
	ud.UNIVERSAL_DOCUMENT_NUMBER REQUEST_NUMBER, -- Заявка
	ptyInfoS.FULL_NAME, -- Заявитель
	ptyInfoS.LAST_NAME, -- Заявитель Фамилия
	ptyInfoS.FIRST_NAME, -- Заявитель Имя
	ptyInfoS.MIDDLE_NAME, ---- Заявитель Отчество
	ptyAddrS.FULL_ADDRESS, -- Куда                  
	p.CONTRACT_NUMBER, -- Номер договора
	ps.ISSUE_DATE, --Дата договора
	ewtAppS.STATEMENT_RECEIVED_DATE RECEIVED_DATE, -- Дата поступления в СК
	(SELECT 
		CAST(
			CASE
				WHEN CHARINDEX(N'Иное', DESCRIPTION, 0) > 0
					THEN (SELECT REPLACE(DESCRIPTION, N'Иное', '') + ewtInqS.TEXT_OF_INQUIRY + '; ') 
				ELSE DESCRIPTION + '; '
			END AS xml)
	FROM BFX_IMPL.INQUIRY_REASON ir
	LEFT JOIN EWT_IMPL.ENDOWMENT_INQUIRY_REASON_SAT_LATEST ewtInqRS ON ewtInqRS.ENDOWMENT_INQUIRY_REASON_HKEY = ewtInqH.ENDOWMENT_INQUIRY_HKEY
	WHERE ewtInqRS.ENDOWMENT_INQUIRY_REASON_HKEY = ewtInqH.ENDOWMENT_INQUIRY_HKEY AND ir.CODE = ewtInqRS.REASON_CODE
	FOR XML PATH('')
	) INQUIRY_ERRORS -- Ошибки запроса

FROM BFX.UNIVERSAL_DOCUMENT ud
LEFT JOIN CFX.PUBLISHED_ARTIFACT paUd ON paUd.PUBLISHED_ARTIFACT_ID = ud.PUBLISHED_ARTIFACT_ID
LEFT JOIN CFG.PROCESS_STATE psUd ON psUd.PROCESS_STATE_ID = ud.STATE_ID
LEFT JOIN EWT_IMPL.ENDOWMENT_INQUIRY_HUB ewtInqH ON ewtInqH.INQUIRY_NUMBER = ud.UNIVERSAL_DOCUMENT_NUMBER
LEFT JOIN EWT_IMPL.ENDOWMENT_INQUIRY_SAT_LATEST ewtInqS ON ewtInqS.ENDOWMENT_INQUIRY_HKEY = ewtInqH.ENDOWMENT_INQUIRY_HKEY
LEFT JOIN EWT_IMPL.EWT_INQUIRY_LINK ewtInqL ON ewtInqL.ENDOWMENT_INQUIRY_HKEY = ewtInqH.ENDOWMENT_INQUIRY_HKEY
LEFT JOIN EWT_IMPL.EWT_HUB ewtH ON ewtH.EWT_HKEY = ewtInqL.EWT_HKEY
LEFT JOIN EWT_IMPL.EWT_CONTRACT_LINK ewtContL ON ewtContL.EWT_HKEY = ewtH.EWT_HKEY
LEFT JOIN EWT_IMPL.EWT_APPLICANT_LINK ewtAppL ON ewtAppL.EWT_HKEY = ewtH.EWT_HKEY
LEFT JOIN EWT_IMPL.EWT_APPLICANT_SAT_LATEST ewtAppS ON ewtAppS.EWT_APPLICANT_HKEY = ewtAppL.EWT_APPLICANT_HKEY
LEFT JOIN PAS_IMPL.POLICY_HUB ph ON ph.POLICY_HKEY = ewtContL.POLICY_HKEY
LEFT JOIN PAS.CONTRACT p ON p.CONTRACT_NUMBER = ph.CONTRACT_NUMBER
LEFT JOIN PAS_IMPL.POLICY_SAT_LATEST ps ON ps.POLICY_HKEY = ph.POLICY_HKEY
LEFT JOIN PTY_IMPL.PARTY_HUB ptyH ON ptyH.PARTY_HKEY = ewtAppL.PARTY_HKEY
LEFT JOIN PTY_IMPL.PARTY_INFO_SAT_LATEST ptyInfoS ON ptyInfoS.PARTY_INFO_HKEY = ptyH.PARTY_HKEY
LEFT JOIN PTY_IMPL.PARTY_ADDRESSES_SAT_LATEST ptyAddrS ON ptyAddrS.PARTY_ADDRESSES_HKEY = ptyH.PARTY_HKEY

WHERE paUd.CODE_NAME = 'EndowmentInquiry'
AND psUd.CODE_NAME NOT IN ('Cancelled', 'Rejected', 'Paid')
AND ewtInqS.STATE = 'Draft'
AND (ewtInqS.DEPARTMENT_CODE = 'agentSalesSupport' OR ewtInqS.DEPARTMENT_CODE = 'partnerSalesSupport' OR ewtInqS.DEPARTMENT_CODE = 'callCenter')
AND ewtInqS.INCLUDED_IN_RP_REGISTER = 'True'
AND ptyAddrS.ADDRESS_TYPE_CODE = 'R'
{{#if parameters.russianPostRegisterInclusionDateFrom}}
    AND CONVERT(date, ewtInqS.INCLUSION_DATE_RP_REGISTER) >= @russianPostRegisterInclusionDateFrom
{{/if}}
{{#if parameters.russianPostRegisterInclusionDateTo}}
    AND CONVERT(date, ewtInqS.INCLUSION_DATE_RP_REGISTER) <= @russianPostRegisterInclusionDateTo
{{/if}}
ORDER BY ud.UNIVERSAL_DOCUMENT_NUMBER
