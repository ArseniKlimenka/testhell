WITH ENTITIES_IDS (ENTITY_ID) AS
(
SELECT VALUE FROM OPENJSON(@entitiesIds)
)
SELECT ATT_RE.ENTITY_REF_ID AS ENTITY_ID,
       ATT.ATTACHMENT_ID,
       ATT.ATTACHMENT_TYPE,
       ATT.NAME AS ATTACHMENT_NAME,
       ATT.FILE_METADATA_ID,
       ATT.SYS_CREATED_ON
  FROM BFX.ATTACHMENT ATT,
       BFX.ATTACHMENT_RELATED_ENTITY ATT_RE,
       ENTITIES_IDS EI
 WHERE ATT.ATTACHMENT_ID = ATT_RE.ATTACHMENT_ID
   AND ATT_RE.ENTITY_REF_ID = EI.ENTITY_ID
{{#if parameters.documentNumber}}
UNION 
SELECT ATT_RE.ENTITY_REF_ID AS ENTITY_ID,
       ATT.ATTACHMENT_ID,
       ATT.ATTACHMENT_TYPE,
       ATT.NAME AS ATTACHMENT_NAME,
       ATT.FILE_METADATA_ID,
       ATT.SYS_CREATED_ON
  FROM BFX.ATTACHMENT ATT,
       BFX.ATTACHMENT_RELATED_ENTITY ATT_RE
WHERE ATT.ATTACHMENT_ID = ATT_RE.ATTACHMENT_ID
AND ATT_RE.ENTITY_REF_ID = (SELECT CONTRACT_ID FROM pas.CONTRACT WHERE CONTRACT_NUMBER = @documentNumber)
{{/if}}