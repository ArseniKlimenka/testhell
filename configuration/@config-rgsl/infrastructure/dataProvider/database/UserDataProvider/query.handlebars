with org_unit_top (organisation_unit_id, organisation_unit_code, top_parent_code)
as
(
select oup.organisation_unit_id,
       oup.organisation_unit_code,
       oup.organisation_unit_code as top_parent_code
  from org.organisation_unit oup
 where oup.parent_id is null
 union all
select ou.organisation_unit_id,
       ou.organisation_unit_code,
       c.top_parent_code as top_parent_code
  from org.organisation_unit ou,
       org_unit_top c
 where ou.parent_id = c.organisation_unit_id
)
SELECT AU.APPLICATION_USER_ID,
       AU.USERNAME,
       AUCP.VALUE AS PARTY_CODE,
       PISL.FULL_NAME AS PARTY_FULL_NAME,
       SP.SERVICE_PROVIDER_CODE AS EMPLOYEE_CODE,
       OUH.ORGANISATION_UNIT_CODE,
       OUISL.NAME AS ORGANISATION_UNIT_NAME,
       SPISL.VISIBILITY_TYPE,
       TOP_SPH.SERVICE_PROVIDER_CODE AS PARTNER_CODE,
       TOP_PISL.FULL_NAME AS PARTNER_DESCRIPTION,
       TOP_PISL.SHORT_NAME AS PARTNER_SHORT_DESCRIPTION,
       TOP_SPISL.PARTNER_CODE PARTNER_BUSINESS_CODE,
       TOP_SPISL.PARTNER_TYPE,
       SPISL.ACTUAL_EMAIL,
	   SSASL.SAD_NUMBER
  FROM ORG.APPLICATION_USER AU,
       ORG.APPLICATION_USER_CLAIM AUCP,
       ORG.SERVICE_PROVIDER SP,
       CFX.PUBLISHED_ARTIFACT PA,
       ORG_IMPL.SERVICE_PROVIDER_HUB SPH,
       ORG_IMPL.SERVICE_PROVIDER_INFO_SAT_LATEST SPISL,
       ORG_IMPL.ORGANISATION_UNIT_HUB OUH,
       ORG_IMPL.ORGANISATION_UNIT_INFO_SAT_LATEST OUISL,
       PTY_IMPL.PARTY_HUB PH,
       PTY_IMPL.PARTY_INFO_SAT_LATEST PISL,
       ORG_UNIT_TOP,
       ORG_IMPL.ORGANISATION_UNIT_HUB TOP_OUH,
       ORG_IMPL.ORGANISATION_UNIT_INFO_SAT_LATEST TOP_OUISL,
       ORG_IMPL.SERVICE_PROVIDER_HUB TOP_SPH,
       ORG_IMPL.SERVICE_PROVIDER_INFO_SAT_LATEST TOP_SPISL,
       PTY_IMPL.PARTY_HUB TOP_PH,
       PTY_IMPL.PARTY_INFO_SAT_LATEST TOP_PISL,
	   ORG_IMPL.SP_SUB_AGENT_SAT_LATEST SSASL
 WHERE 1=1
   AND AU.APPLICATION_USER_ID = AUCP.APPLICATION_USER_ID
   AND AUCP.CLAIM_TYPE = N'PartyCode'
   AND AUCP.VALUE = SP.PARTY_CODE
   AND SP.PUBLISHED_ARTIFACT_ID = PA.PUBLISHED_ARTIFACT_ID
   AND PA.CODE_NAME = N'Employee'
   AND SPH.SERVICE_PROVIDER_CODE = SP.SERVICE_PROVIDER_CODE
   AND SPISL.SERVICE_PROVIDER_INFO_HKEY = SPH.SERVICE_PROVIDER_HKEY
   AND OUH.ORGANISATION_UNIT_CODE = SPISL.ORGANISATION_UNIT_CODE
   AND OUISL.ORGANISATION_UNIT_INFO_HKEY = OUH.ORGANISATION_UNIT_HKEY
   AND AUCP.VALUE = PH.PARTY_CODE
   AND PH.PARTY_HKEY = PISL.PARTY_INFO_HKEY
   AND ORG_UNIT_TOP.ORGANISATION_UNIT_CODE = SPISL.ORGANISATION_UNIT_CODE
   AND TOP_OUH.ORGANISATION_UNIT_CODE = ORG_UNIT_TOP.TOP_PARENT_CODE
   AND TOP_OUISL.ORGANISATION_UNIT_INFO_HKEY = TOP_OUH.ORGANISATION_UNIT_HKEY
   AND TOP_SPH.SERVICE_PROVIDER_CODE = TOP_OUISL.PARTNER_CODE
   AND TOP_SPISL.SERVICE_PROVIDER_INFO_HKEY = TOP_SPH.SERVICE_PROVIDER_HKEY
   AND TOP_SPISL.PARTY_CODE = TOP_PH.PARTY_CODE
   AND TOP_PH.PARTY_HKEY = TOP_PISL.PARTY_INFO_HKEY
   AND SSASL.SP_SUB_AGENT_HKEY = SPH.SERVICE_PROVIDER_HKEY
{{#if parameters.employeeCode}}
   AND SP.SERVICE_PROVIDER_CODE = @employeeCode
{{/if}}
{{#if parameters.userId}}
   AND AU.APPLICATION_USER_ID = @userId
{{/if}}
{{#if parameters.partnerCode}}
   AND TOP_SPH.SERVICE_PROVIDER_CODE = @partnerCode
{{/if}}
{{#if parameters.actualEmail}}
   AND SPISL.ACTUAL_EMAIL = @actualEmail
{{/if}}
{{#if parameters.sadNumber}}
	and SSASL.SAD_NUMBER = @sadNumber
{{/if}}