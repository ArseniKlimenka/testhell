SELECT 
	hist.NEW_STATE,
	hist.TRANSITION,
	hist.CHANGED_ON,
	COALESCE(pinfo.FULL_NAME, users.USERNAME) as CHANGED_BY_USER,
	users.APPLICATION_USER_ID as CHANGED_BY_USER_ID,
	pub.CODE_NAME
FROM
	BFX.ENTITY_HISTORY hist
INNER JOIN 
	BFX.ENTITY_REF ent ON ent.ENTITY_ID = hist.ENTITY_ID
INNER JOIN 
	CFX.PUBLISHED_ARTIFACT pub ON pub.PUBLISHED_ARTIFACT_ID = ent.PUBLISHED_ARTIFACT_ID
INNER JOIN 
	ORG.APPLICATION_USER users ON users.APPLICATION_USER_ID = hist.CHANGE_CAUSED_BY
LEFT JOIN 
	ORG.APPLICATION_USER_CLAIM partyCodeClaim ON partyCodeClaim.APPLICATION_USER_ID = users.APPLICATION_USER_ID AND partyCodeClaim.CLAIM_TYPE = 'PartyCode'
LEFT JOIN 
	PTY_IMPL.PARTY_HUB phub ON phub.PARTY_CODE = partyCodeClaim.VALUE
LEFT JOIN 
	PTY_IMPL.PARTY_INFO_SAT_LATEST pinfo ON pinfo.PARTY_INFO_HKEY = phub.PARTY_HKEY
WHERE
	1 = 1
	{{#if parameters.entityId}}
    AND hist.ENTITY_ID = @entityId
    {{/if}}
	{{#if parameters.documentCode}}
    AND hist.BUSINESS_ID = @documentCode
    {{/if}}	
	AND STATE_CHANGED = 1