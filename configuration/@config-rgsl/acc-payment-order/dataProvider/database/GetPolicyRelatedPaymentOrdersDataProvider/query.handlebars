SELECT rs.PAYMENT_ORDER_NUMBER,
	   rs.PAYMENT_ORDER_TYPE,
	   rs.PAYMENT_ORDER_DATE,
	   rs.PO_SATE,
	   rs.DOCUMENT_NUMBER,
	   rs.DOC_SEQ_NUMBER,
	   rs.DOC_PARENT_NUMBER,
	   rs.DOC_CONF,
	   rs.DOC_ENTITY_TYPE,
	   rs.NEW_STATE AS DOC_STATE,
	   rs.CHANGED_ON AS DOC_STATE_DATE
FROM
(SELECT mq.PAYMENT_ORDER_NUMBER,
	    mq.PAYMENT_ORDER_TYPE,
	    mq.PAYMENT_ORDER_DATE,
	    mq.PO_SATE,
	    mq.DOCUMENT_NUMBER,
		mq.SEQ_NUMBER AS DOC_SEQ_NUMBER,
		mq.CONTRACT_NUMBER AS DOC_PARENT_NUMBER,
		pa.CODE_NAME AS DOC_CONF,
		et.CODE_NAME AS DOC_ENTITY_TYPE,
		docHist.NEW_STATE,
		docHist.CHANGED_ON,
	    RANK() OVER (PARTITION BY mq.PAYMENT_ORDER_NUMBER ORDER BY mq.PAYMENT_ORDER_NUMBER, docHist.HISTORY_VERSION DESC) AS RANK
FROM
(SELECT  poHub.PAYMENT_ORDER_NUMBER,
	     poSat.PAYMENT_ORDER_TYPE,
	     poSat.PAYMENT_ORDER_DATE,
		 poHist.NEW_STATE AS PO_SATE,
		 COALESCE(clm.CLAIM_NUMBER, ctr.CONTRACT_NUMBER) AS DOCUMENT_NUMBER,
		 ctr.SEQ_NUMBER,
		 poSat.CONTRACT_NUMBER,
	     RANK() OVER (PARTITION BY poHub.PAYMENT_ORDER_NUMBER ORDER BY poHub.PAYMENT_ORDER_NUMBER, poHist.HISTORY_VERSION DESC) AS RANK
FROM  ACC_IMPL.PAYMENT_ORDER_HUB poHub
JOIN  ACC_IMPL.PAYMENT_ORDER_SAT_LATEST poSat on poHub.PAYMENT_ORDER_HKEY = poSat.PAYMENT_ORDER_HKEY
JOIN  BFX.ENTITY_HISTORY poHist ON poHist.BUSINESS_ID = poHub.PAYMENT_ORDER_NUMBER AND poHist.STATE_CHANGED = 1
LEFT JOIN CLM.CLAIM clm ON clm.CLAIM_NUMBER = poSat.REFERENCE_NUMBER
LEFT JOIN PAS.CONTRACT ctr ON ctr.CONTRACT_NUMBER = poSat.CONTRACT_AMENDMENT_NUMBER
WHERE poSat.CONTRACT_NUMBER = @contractNumber) mq
JOIN BFX.ENTITY_HISTORY docHist ON mq.RANK = 1 AND docHist.BUSINESS_ID = mq.DOCUMENT_NUMBER AND docHist.STATE_CHANGED = 1
LEFT JOIN BFX.ENTITY_REF e on docHist.ENTITY_ID = e.ENTITY_ID
LEFT JOIN CFX.PUBLISHED_ARTIFACT pa ON pa.PUBLISHED_ARTIFACT_ID = e.PUBLISHED_ARTIFACT_ID
LEFT JOIN CFG.ENTITY_TYPE et on et.ENTITY_TYPE_ID = e.ENTITY_TYPE_ID) rs
WHERE rs.RANK = 1