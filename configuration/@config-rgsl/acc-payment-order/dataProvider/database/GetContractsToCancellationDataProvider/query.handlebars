SELECT DISTINCT sel.CONTRACT_NUMBER, sel.STATE_ID, art.CODE_NAME AS CONF_CODE_NAME
FROM (
	SELECT CONTRACT_NUMBER, con.STATE_ID, PUBLISHED_ARTIFACT_ID, DATEDIFF(day,con.VALID_FROM, GETDATE()) AS Days_Diff 
	FROM PAS.CONTRACT con) sel
JOIN CFX.PUBLISHED_ARTIFACT art ON art.PUBLISHED_ARTIFACT_ID = sel.PUBLISHED_ARTIFACT_ID
INNER JOIN CFG.PROCESS_STATE ps ON ps.PROCESS_STATE_ID = sel.STATE_ID
INNER JOIN PAS_IMPL.POLICY_HUB ph ON ph.CONTRACT_NUMBER = sel.CONTRACT_NUMBER
INNER JOIN PAS_IMPL.POLICY_SAT_LATEST psat ON psat.POLICY_HKEY = ph.POLICY_HKEY
WHERE sel.Days_Diff >= 100 
	AND ps.CODE_NAME IN ('Draft', 'Active')
    AND (psat.IS_MIGRATED = 0 OR psat.IS_MIGRATED IS NULL)