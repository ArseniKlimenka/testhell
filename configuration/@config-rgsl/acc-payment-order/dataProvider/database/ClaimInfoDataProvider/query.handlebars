SELECT cHub.CLAIM_NUMBER,
	   pHub.CONTRACT_NUMBER,
	   rSat.CODE AS RISK_CODE,
	   rSat.DESCRIPTION AS RISK_DESCRIPTION,
	   aSat.STATEMENT_RECEIVED_DATE,
	   ieSat.CONTRACT_CURRENCY,
	   cSat.SHOULD_USE_NETTING,
	   cSat.NON_ACCEPTANCE,
	   cSat.NUM_OF_NON_ACCEPTANCE_PAYMENT AS NON_ACCEPTANCE_PAYMENT_NUMBER,
	   cSat.FIXED_EXCH_RATE,
	   cSat.USE_FIXED_EXCH_RATE,
	   paHub.PARTY_CODE AS BENEFICIARY_PARTY_CODE,
	   bSat.AMOUNT_TO_PAY AS AMOUNT_IN_CONTRACT_CURRENCY,
	   bSat.AMOUNT_TO_PAY_RUB_CUR AS AMOUNT_IN_RUB,
	   bSat.BANK_ACCOUNT_NUMBER,
	   	(
		select
			json_value([value], '$.lineType') as lineType,
			json_value([value], '$.lineAmountInContractCurrency') as lineAmountInContractCurrency,
			json_value([value], '$.lineAmountInRubCurrency') as lineAmountInRubCurrency
		from openjson(c.BODY,'$.claimAmounts.paymentLines') pl
		for json path
		) as PAYMENT_LINES,
		bSat.AMOUNT_TO_PAY_PERCENTAGE
FROM CLM_IMPL.CLM_HUB cHub
INNER JOIN CLM.CLAIM c ON c.CLAIM_NUMBER = cHub.CLAIM_NUMBER
INNER JOIN CLM_IMPL.CLM_SAT_LATEST cSat ON cSat.CLM_HKEY = cHub.CLM_HKEY
INNER JOIN CLM_IMPL.CLM_RISK_SAT_LATEST rSat ON rSat.CLM_RISK_HKEY = cHub.CLM_HKEY AND rSat.IS_DELETED = 0
INNER JOIN CLM_IMPL.CLM_APPLICANT_LINK aLink ON aLink.CLM_HKEY = cHub.CLM_HKEY
INNER JOIN CLM_IMPL.CLM_APPLICANT_SAT_LATEST aSat ON aSat.CLM_APPLICANT_HKEY = aLink.CLM_APPLICANT_HKEY AND aSat.IS_DELETED = 0
INNER JOIN CLM_IMPL.CLM_IE_LINK ieLink ON ieLink.CLM_HKEY = cHub.CLM_HKEY
INNER JOIN CLM_IMPL.CLM_IE_SAT_LATEST ieSat ON ieSat.CLM_IE_HKEY = ieLink.CLM_IE_HKEY AND ieSat.IS_DELETED = 0
INNER JOIN CLM_IMPL.IE_CONTRACT_LINK cLink ON cLink.IE_HKEY = ieLink.IE_HKEY
INNER JOIN CLM_IMPL.IE_CONTRACT_SAT_LATEST ctrSat ON ctrSat.IE_CONTRACT_HKEY = cLink.IE_CONTRACT_HKEY AND ctrSat.IS_DELETED = 0
INNER JOIN PAS_IMPL.POLICY_HUB pHub ON pHub.POLICY_HKEY = cLink.POLICY_HKEY
INNER JOIN CLM_IMPL.CLM_BENEFICIARY_LINK bLink ON bLink.CLM_HKEY = cHub.CLM_HKEY
INNER JOIN PTY_IMPL.PARTY_HUB paHub ON paHub.PARTY_HKEY = bLink.PARTY_HKEY
INNER JOIN CLM_IMPL.CLM_BENEFICIARY_SAT_LATEST bSat ON bSat.CLM_BENEFICIARY_HKEY = bLink.CLM_BENEFICIARY_HKEY AND bSat.IS_DELETED = 0
LEFT JOIN ACC.PAYMENT_ORDER po ON po.PAYMENT_ORDER_NUMBER = bSat.ASSIGNED_PO_NUMBER
LEFT JOIN CFG.PROCESS_STATE st on st.PROCESS_STATE_ID = po.STATE_ID
WHERE cHub.CLAIM_NUMBER = @documentNumber
AND paHub.PARTY_CODE = @beneficiaryCode
AND (st.CODE_NAME IS NULL OR st.CODE_NAME = 'Cancelled')