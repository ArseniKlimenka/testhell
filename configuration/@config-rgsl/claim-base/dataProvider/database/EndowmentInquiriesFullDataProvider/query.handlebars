SELECT r.UNIVERSAL_DOCUMENT_ID,
	   r.UNIVERSAL_DOCUMENT_NUMBER,
	   r.SYS_CREATED_ON,
	   r.SYS_UPDATED_ON,
	   r.STATE,
	   r.DEPARTMENT_CODE,
	   r.CHANGED_BY_USER,
	   r.CHANGED_BY_PARTY,
	   r.CHANGED_BY_PARTY_CODE,
	   r.CHANGED_ON,
	   r.TEXT_OF_INQUIRY,
	   r.TEXT_OF_ANSWER,
	   r.TEXT_OF_COMMENT
FROM
(SELECT inqDoc.UNIVERSAL_DOCUMENT_ID,
	    inqDoc.UNIVERSAL_DOCUMENT_NUMBER,
	    inqDoc.SYS_CREATED_ON,
	    inqDoc.SYS_UPDATED_ON,
	    st.CODE_NAME AS STATE,
	    inqSat.DEPARTMENT_CODE,
		users.USERNAME as CHANGED_BY_USER,
		uclaim.VALUE as CHANGED_BY_PARTY,
		upclaim.VALUE as CHANGED_BY_PARTY_CODE,
		hist.CHANGED_ON,
		inqSat.TEXT_OF_INQUIRY,
		inqSat.TEXT_OF_ANSWER,
		inqSat.TEXT_OF_COMMENT,
	    ROW_NUMBER() OVER (PARTITION BY hist.BUSINESS_ID ORDER BY hist.CHANGED_ON DESC) ROW_NUM
FROM
	BFX.UNIVERSAL_DOCUMENT inqDoc
	JOIN CFG.PROCESS_STATE st ON st.PROCESS_STATE_ID = inqDoc.STATE_ID
	JOIN EWT_IMPL.ENDOWMENT_INQUIRY_HUB inqHub ON inqHub.INQUIRY_NUMBER = inqDoc.UNIVERSAL_DOCUMENT_NUMBER
	JOIN EWT_IMPL.ENDOWMENT_INQUIRY_SAT_LATEST inqSat ON inqSat.ENDOWMENT_INQUIRY_HKEY = inqHub.ENDOWMENT_INQUIRY_HKEY
	JOIN EWT_IMPL.EWT_INQUIRY_LINK inqLink ON inqLink.ENDOWMENT_INQUIRY_HKEY = inqHub.ENDOWMENT_INQUIRY_HKEY
	JOIN EWT_IMPL.EWT_HUB amndHub ON amndHub.EWT_HKEY = inqLink.EWT_HKEY
	JOIN BFX.ENTITY_HISTORY hist ON hist.BUSINESS_ID = inqDoc.UNIVERSAL_DOCUMENT_NUMBER
	LEFT JOIN ORG.APPLICATION_USER users ON users.APPLICATION_USER_ID = hist.CHANGE_CAUSED_BY
	LEFT JOIN ORG.APPLICATION_USER_CLAIM uclaim ON uclaim.APPLICATION_USER_ID = hist.CHANGE_CAUSED_BY AND uclaim.CLAIM_TYPE = 'DisplayName'
	LEFT JOIN ORG.APPLICATION_USER_CLAIM upclaim ON upclaim.APPLICATION_USER_ID = hist.CHANGE_CAUSED_BY AND upclaim.CLAIM_TYPE = 'PartyCode'
	LEFT JOIN bfx.ENTITY_REF e on hist.ENTITY_ID = e.ENTITY_ID
	LEFT JOIN CFX.PUBLISHED_ARTIFACT pa ON pa.PUBLISHED_ARTIFACT_ID = e.PUBLISHED_ARTIFACT_ID
WHERE 1=1
	and amndHub.ENDOWMENT_NUMBER = @endowmentNumber
	AND hist.NEW_STATE = st.CODE_NAME
	AND hist.STATE_CHANGED = 1
) r
WHERE r.ROW_NUM = 1