WITH DOC_NUM as (
SELECT TOP 1 d.IMPORT_DOCUMENT_ID, d.IMPORT_DOCUMENT_NUMBER
FROM BFX.IMPORT_DOCUMENT d
JOIN BFX.ENTITY_REF ref ON ref.ENTITY_REF_ID = d.SOURCE_ENTITY_ID
JOIN BFX.ENTITY_HISTORY hist ON hist.ENTITY_ID = d.IMPORT_DOCUMENT_ID
WHERE ref.BUSINESS_KEY = @claimNumber
AND NEW_STATE = 'Loaded'
ORDER BY CHANGED_ON DESC
)

SELECT *
FROM
(
SELECT TOP 1000000
    @claimNumber as CLAIM_NUMBER,
    @claimId as CLAIM_ID,
    @contractNumber as CONTRACT_NUMBER,
    r.IMPORT_DOCUMENT_ID,
    r.IMPORT_DOCUMENT_NUMBER,
    r.SOURCE_ID,
    r.RECORD_KEY,
    r.DATA,
    r.LOAD_DATE,
	r.N
from
(
    SELECT
        idr.IMPORT_DOCUMENT_ID,
        dn.IMPORT_DOCUMENT_NUMBER,
        idr.SOURCE_ID,
        idr.RECORD_KEY,
        idr.DATA,
        idr.LOAD_DATE,
        ROW_NUMBER() OVER (PARTITION BY idr.RECORD_KEY  ORDER BY idr.LOAD_DATE desc) as N
    FROM BFX.IMPORT_DATA_RECORD idr
	JOIN DOC_NUM dn ON dn.IMPORT_DOCUMENT_ID = idr.IMPORT_DOCUMENT_ID
) r
where r.N = 1
) t