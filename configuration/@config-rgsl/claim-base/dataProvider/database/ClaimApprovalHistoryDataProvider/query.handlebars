SELECT * FROM
(SELECT uclaim.VALUE AS APPROVED_BY,
	   hist.CHANGED_ON AS APPROVED_ON,
	   act.USER_GROUP_CODE AS APPROVED_BY_GROUP,
	   hist.OLD_STATE,
	   hist.NEW_STATE,
	   hist.TRANSITION,
	   ROW_NUMBER() OVER(PARTITION BY hist.TRANSITION ORDER BY hist.CHANGED_ON DESC) AS ROW_NUM 
FROM BFX.ENTITY_HISTORY hist
JOIN CFG.PROCESS_STATE st ON st.CODE_NAME = hist.OLD_STATE
JOIN BFX.ENTITY_REF ref on ref.ENTITY_ID = hist.ENTITY_ID
JOIN BFX.ACTIVITY act ON act.DOCUMENT_STATE = st.PROCESS_STATE_ID AND act.ENTITY_REF_ID = ref.ENTITY_REF_ID
JOIN ORG.APPLICATION_USER users ON users.APPLICATION_USER_ID = hist.CHANGE_CAUSED_BY
JOIN ORG.APPLICATION_USER_CLAIM uclaim ON uclaim.APPLICATION_USER_ID = hist.CHANGE_CAUSED_BY AND uclaim.CLAIM_TYPE = 'DisplayName'
WHERE BUSINESS_ID = @documentNumber and STATE_CHANGED = 1) main
WHERE main.ROW_NUM = 1