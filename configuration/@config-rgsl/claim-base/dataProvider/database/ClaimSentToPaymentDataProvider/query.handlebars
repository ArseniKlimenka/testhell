with PO_ACTIVE as 
(
	SELECT 
		tpo.PAYMENT_ORDER_NUMBER,
		tpo.STATE_CODE
	FROM
		(SELECT po.PAYMENT_ORDER_NUMBER,
				hist.NEW_STATE as STATE_CODE,
				hist.HISTORY_VERSION,
				MAX(hist.HISTORY_VERSION) over(partition by po.PAYMENT_ORDER_NUMBER) AS HISTORY_VERSION_MAX,
				ps.CONTRACT_NUMBER,
				ps.CONTRACT_AMENDMENT_NUMBER,
				ps.PAYMENT_ORDER_TYPE
		 FROM acc.PAYMENT_ORDER po
			JOIN bfx.ENTITY_HISTORY hist on hist.BUSINESS_ID = po.PAYMENT_ORDER_NUMBER
			JOIN acc_impl.PAYMENT_ORDER_HUB ph on ph.PAYMENT_ORDER_NUMBER = po.PAYMENT_ORDER_NUMBER
			JOIN acc_impl.PAYMENT_ORDER_SAT_LATEST ps on ps.PAYMENT_ORDER_HKEY = ph.PAYMENT_ORDER_HKEY) tpo
	WHERE tpo.HISTORY_VERSION = tpo.HISTORY_VERSION_MAX
	AND (tpo.STATE_CODE != 'Cancelled' OR tpo.STATE_CODE IS NULL)
),

PO_DRAFT as 
(
	SELECT tpo.PAYMENT_ORDER_NUMBER,
		   tpo.SYS_CREATED_ON
	FROM
		(SELECT po.PAYMENT_ORDER_NUMBER,
				po.SYS_CREATED_ON,
				hist.HISTORY_VERSION,
				MIN(hist.HISTORY_VERSION) over(partition by po.PAYMENT_ORDER_NUMBER) AS HISTORY_VERSION_MIN
		 FROM acc.PAYMENT_ORDER po
			JOIN bfx.ENTITY_HISTORY hist on hist.BUSINESS_ID = po.PAYMENT_ORDER_NUMBER) tpo
	WHERE tpo.HISTORY_VERSION = tpo.HISTORY_VERSION_MIN
),

PO_APPROVED as
(
	SELECT 
		tpo.PAYMENT_ORDER_NUMBER,
		tpo.SYS_UPDATED_ON
	FROM
		(SELECT po.PAYMENT_ORDER_NUMBER,
				po.SYS_UPDATED_ON,
				hist.HISTORY_VERSION,
				MAX(hist.HISTORY_VERSION) over(partition by po.PAYMENT_ORDER_NUMBER) AS HISTORY_VERSION_MAX
		 FROM acc.PAYMENT_ORDER po
			JOIN bfx.ENTITY_HISTORY hist on hist.BUSINESS_ID = po.PAYMENT_ORDER_NUMBER
			WHERE hist.NEW_STATE = 'Approved') tpo
	WHERE tpo.HISTORY_VERSION = tpo.HISTORY_VERSION_MAX
)

SELECT 
	ieHub.IE_NUMBER,
	cl.CLAIM_NUMBER,
	poInsAct.ACT_NUMBER INSURANCE_ACT,
	paySat.BASE_DOC_RECIPIENT_NAME,
	poInsAct.SIGNED_ON INSURANCE_ACT_SIGNATURE_DATE_TIME,
	payH.PAYMENT_ORDER_NUMBER PO_NUMBER,
	pod.SYS_CREATED_ON PO_CREATED_DATE_TIME,
	poApp.SYS_UPDATED_ON PO_TO_PAY_DATE_TIME, 
	paySat.PO_CURRENCY_AMOUNT,
	paySat.TOTAL_NETTED_AMOUNT,
	clmSat.CLAIM_STATE,
	clmSat.LOAD_DATE CLAIM_LOAD_DATE_TIME
FROM CLM.CLAIM cl
JOIN CLM_IMPL.CLM_HUB clmHub ON clmHub.CLAIM_NUMBER = cl.CLAIM_NUMBER
JOIN CLM_IMPL.CLM_SAT_LATEST clmSat ON clmSat.CLM_HKEY = clmHub.CLM_HKEY
JOIN CLM_IMPL.CLM_IE_LINK clmIeLink ON clmIeLink.CLM_HKEY = clmHub.CLM_HKEY
JOIN CLM_IMPL.IE_HUB ieHub ON ieHub.IE_HKEY = clmIeLink.IE_HKEY
JOIN ACC_IMPL.PAYMENT_ORDER_SAT_LATEST paySat on paySat.REFERENCE_NUMBER = cl.CLAIM_NUMBER
JOIN ACC_IMPL.PAYMENT_ORDER_HUB payH on payH.PAYMENT_ORDER_HKEY = paySat.PAYMENT_ORDER_HKEY
JOIN PO_ACTIVE poact ON poact.PAYMENT_ORDER_NUMBER = payH.PAYMENT_ORDER_NUMBER
JOIN PO_DRAFT pod ON pod.PAYMENT_ORDER_NUMBER = payH.PAYMENT_ORDER_NUMBER
LEFT JOIN PO_APPROVED poApp ON poApp.PAYMENT_ORDER_NUMBER = payH.PAYMENT_ORDER_NUMBER
JOIN ACC_IMPL.PO_INSURANCE_ACT_SAT poInsAct ON poInsAct.PO_INSURANCE_ACT_HKEY = payH.PAYMENT_ORDER_HKEY

WHERE 1=1

    {{#if parameters.claimState}}
        AND clmSat.CLAIM_STATE = @claimState
    {{/if}}

    {{#if parameters.claimStateFrom}}
        AND clmSat.LOAD_DATE >= @claimStateFrom
    {{/if}}
    
    {{#if parameters.claimStateTo}}
        AND clmSat.LOAD_DATE <= @claimStateTo
    {{/if}}
