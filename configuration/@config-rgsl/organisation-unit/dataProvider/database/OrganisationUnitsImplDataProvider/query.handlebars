{{#if parameters.headOrgUnitCode}}
WITH CHILDREN_BY_HEAD_UNIT (ORGANISATION_UNIT_ID)
AS
(
SELECT OUP.ORGANISATION_UNIT_ID
FROM ORG.ORGANISATION_UNIT OUP
WHERE OUP.ORGANISATION_UNIT_CODE = @headOrgUnitCode
UNION ALL
SELECT OU.ORGANISATION_UNIT_ID
FROM ORG.ORGANISATION_UNIT OU
JOIN CHILDREN_BY_HEAD_UNIT C ON OU.PARENT_ID = C.ORGANISATION_UNIT_ID
)
{{/if}}

{{#if parameters.headPartnerCode}}
WITH CHILDREN_BY_PARTNER (ORGANISATION_UNIT_ID)
AS
(
SELECT OUP.ORGANISATION_UNIT_ID
FROM ORG.ORGANISATION_UNIT OUP
JOIN ORG_IMPL.ORGANISATION_UNIT_HUB HUB ON OUP.ORGANISATION_UNIT_CODE = HUB.ORGANISATION_UNIT_CODE
JOIN ORG_IMPL.ORGANISATION_UNIT_INFO_SAT_LATEST SAT ON HUB.ORGANISATION_UNIT_HKEY = SAT.ORGANISATION_UNIT_INFO_HKEY
WHERE SAT.PARTNER_CODE = @headPartnerCode
UNION ALL
SELECT OU.ORGANISATION_UNIT_ID
FROM ORG.ORGANISATION_UNIT OU
JOIN CHILDREN_BY_PARTNER C ON OU.PARENT_ID = C.ORGANISATION_UNIT_ID
)
{{/if}}

SELECT OU.ORGANISATION_UNIT_CODE,
OU.ORGANISATION_UNIT_ID,
OU.PARENT_ID,
SAT.NAME,
SAT.CODE,
SAT.PARTNER_CODE
FROM ORG.ORGANISATION_UNIT OU,
ORG_IMPL.ORGANISATION_UNIT_HUB HUB,
ORG_IMPL.ORGANISATION_UNIT_INFO_SAT_LATEST SAT
WHERE OU.ORGANISATION_UNIT_CODE = HUB.ORGANISATION_UNIT_CODE
AND HUB.ORGANISATION_UNIT_HKEY = SAT.ORGANISATION_UNIT_INFO_HKEY
{{#if parameters.headOrgUnitCode}}
AND OU.ORGANISATION_UNIT_ID IN (SELECT ORGANISATION_UNIT_ID FROM CHILDREN_BY_HEAD_UNIT)
{{/if}}
{{#if parameters.headPartnerCode}}
AND OU.ORGANISATION_UNIT_ID IN (SELECT ORGANISATION_UNIT_ID FROM CHILDREN_BY_PARTNER)
{{/if}}
{{#if parameters.name}}
AND SAT.NAME LIKE @name
{{/if}}
{{#if parameters.businessCode}}
AND SAT.CODE = @businessCode
{{/if}}
{{#if parameters.partnerCode}}
AND SAT.PARTNER_CODE = @partnerCode
{{/if}}
{{#if parameters.userAdditionalOrgUnits}}
AND OU.ORGANISATION_UNIT_CODE in (SELECT VALUE FROM OPENJSON(@userAdditionalOrgUnits))
{{/if}}
{{#if parameters.orgUnitCode}}
AND OU.ORGANISATION_UNIT_CODE = @orgUnitCode
{{/if}}